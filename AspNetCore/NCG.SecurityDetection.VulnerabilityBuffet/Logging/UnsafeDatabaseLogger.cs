using Microsoft.Data.SqlClient;
using Microsoft.Extensions.Logging;
using NCG.SecurityDetection.VulnerabilityBuffet.Data;
using System;
using System.Collections.Generic;

namespace NCG.SecurityDetection.VulnerabilityBuffet.Logging
{
    public class UnsafeDatabaseLogger : ILogger
    {
        private readonly string _username = "ApplicationLogUser";
        private readonly string _password = "P@ssw0rd*";

        public IDisposable BeginScope<TState>(TState state) => default!;

        public bool IsEnabled(LogLevel logLevel)
        {
            return true;
        }

        public void Log<TState>(LogLevel logLevel, EventId eventId, TState state, Exception exception, Func<TState, Exception, string> formatter)
        {
            using (var connection = new SqlConnection("Server=localhost\\SQL2019;Initial Catalog=VulnerabilityBuffet;Persist Security Info=False;User ID=" + _username + ";Password=" + _password + ";MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=True;Connection Timeout=30;"))
            {
                var text = state == null ? string.Empty : state.ToString();

                var command = connection.CreateCommand();
                command.CommandText = $"INSERT ApplicationLog (LogLevel, LogText, DateLogged) VALUES ('{logLevel}', '{text}', '{DateTime.UtcNow}')";

                connection.Open();

                command.ExecuteNonQuery();

                connection.Close();
            }
        }
    }
}
