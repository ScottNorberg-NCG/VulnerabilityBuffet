using System;
using System.Collections.Generic;
using Microsoft.Data.SqlClient;
using System.IO;
using System.Linq;
using System.Security.Cryptography;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using NCG.SecurityDetection.VulnerabilityBuffet.Authentication;
using NCG.SecurityDetection.VulnerabilityBuffet.Data;
using NCG.SecurityDetection.VulnerabilityBuffet.Models;

namespace NCG.SecurityDetection.VulnerabilityBuffet.Controllers
{
    [AutoValidateAntiforgeryToken]
    [CustomAuthorize]
    public class AuthOnlyController : Controller
    {
        ApplicationDbContext _dbContext;
        private readonly AuthManager _authManager;
        private readonly IHostingEnvironment _hostEnvironment;

        private readonly string _linkedInClientID = "81i0rmk966gbbm";
        private readonly string _linkedInSecret = "YsaCtkgttwfXSa9O";

        public AuthOnlyController(ApplicationDbContext context, AuthManager authManager, IHostingEnvironment hostEnvironment)
        {
            _dbContext = context;
            _authManager = authManager;
            _hostEnvironment = hostEnvironment;
        }

        public IActionResult Index()
        {
            return View();
        }

        public IActionResult SQLi(string foodName)
        {
            var model = CreateUnsafeGenericModel(foodName);
            return View(model);
        }

        public IActionResult XSS(string foodName)
        {
            var model = new AccountUserViewModel();
            model.SearchText = foodName;
            model.Foods = _dbContext.ExecSQL<FoodDisplayView>("SELECT * FROM FoodDisplayView WHERE FoodName LIKE '%' + @FoodName + '%'", new SqlParameter("@FoodName", foodName));
            return View(model);
        }

        public IActionResult StoredSQLi()
        {
            var user = _authManager.GetLoggedInUser();

            if (user == null)
            {
                return NotFound($"Unable to load user.");
            }

            var food = user.FavoriteFood == null ? "(Not set)" : user.FavoriteFood;
            var model = CreateUnsafeGenericModel(food);
            return View(model);
        }

        public IActionResult StoredXSS()
        {
            var user = _authManager.GetLoggedInUser();
            if (user == null)
            {
                return NotFound($"Unable to load user.");
            }

            var foodGroup = user.FavoriteFoodGroup == null ? "(Not set)" : user.FavoriteFoodGroup;

            var model = new AccountUserViewModel();
            model.SearchText = foodGroup;
            model.Foods = _dbContext.ExecSQL<FoodDisplayView>("SELECT * FROM FoodDisplayView WHERE FoodGroup LIKE '%' + @FoodGroup + '%'", new SqlParameter("@FoodGroup", foodGroup));
            return View(model);
        }

        [HttpGet]
        public IActionResult SafeFileUpload()
        {
            var user = _authManager.GetLoggedInUser();
            ViewBag.Files = _dbContext.UserFiles.Where(f => f.UserID == user.UserID).ToList();
            ViewBag.Message = "";

            return View();
        }

        [ValidateAntiForgeryToken]
        [HttpPost]
        public IActionResult SafeFileUpload(SafeFileUploadViewModel model)
        {
            var user = _authManager.GetLoggedInUser();
            ViewBag.Files = _dbContext.UserFiles.Where(f => f.UserID == user.UserID).ToList();

            var extension = Path.GetExtension(model.FileBytes.FileName);

            byte[] fileBytes;

            using (var stream = model.FileBytes.OpenReadStream())
            {
                fileBytes = new byte[stream.Length];

                for (int i = 0; i < stream.Length; i++)
                {
                    fileBytes[i] = (byte)stream.ReadByte();
                }
            }

            if (fileBytes.Length > 2097152)
            {
                ViewBag.Message = $"File too large.";
                return View();
            }

            switch (extension)
            {
                case ".jpg":
                case ".jpeg":
                    if (fileBytes[0] != 255 || fileBytes[1] != 216 || fileBytes[2] != 255)
                    {
                        ViewBag.Message = $"Image appears not to be in jpg format. Please try another.";
                        return View();
                    }
                    else if (fileBytes[3] != 219 && fileBytes[3] != 224 && fileBytes[3] != 238 && fileBytes[3] != 225)
                    {
                        ViewBag.Message = $"Image appears not to be in jpg format. Please try another.";
                        return View();
                    }
                    break;
                case ".gif":
                    if (fileBytes[0] != 71 || fileBytes[1] != 73 || fileBytes[2] != 70 || fileBytes[3] != 56 || fileBytes[5] != 97)
                    {
                        ViewBag.Message = $"Image appears not to be in gif format. Please try another.";
                        return View();
                    }
                    else if (fileBytes[4] != 55 && fileBytes[4] != 57)
                    {
                        ViewBag.Message = $"Image appears not to be in gif format. Please try another.";
                        return View();
                    }
                    break;
                case ".png":
                    if (fileBytes[0] != 137 || fileBytes[1] != 80 || fileBytes[2] != 78 || fileBytes[3] != 71 || 
                        fileBytes[4] != 13 || fileBytes[5] != 10 || fileBytes[6] != 26 || fileBytes[7] != 10)
                    {
                        ViewBag.Message = $"Image appears not to be in png format. Please try another.";
                        return View();
                    }
                    break;
                default:
                    ViewBag.Message = $"Extension {extension} is not supported";
                    return View();
            }

            var userFile = new UserFile();
            userFile.UserID = user.UserID;
            userFile.FileName = model.FileName;
            userFile.FileExtension = extension;
            userFile.FileBytes = fileBytes;
            userFile.CreatedOn = DateTime.Now;

            _dbContext.UserFiles.Add(userFile);
            _dbContext.SaveChanges();

            ViewBag.Files = _dbContext.UserFiles.Where(f => f.UserID == user.UserID).ToList();
            ViewBag.Message = "File saved successfully";

            return View();
        }

        [HttpGet]
        public IActionResult UnsafeFileUpload()
        {
            ViewBag.Files = GetUploadedFiles();
            ViewBag.Message = "";

            return View();
        }

        [HttpPost]
        public IActionResult UnsafeFileUpload(IFormFile file)
        {
            ViewBag.Files = GetUploadedFiles();

            byte[] fileBytes;

            using (var stream = file.OpenReadStream())
            {
                fileBytes = new byte[stream.Length];

                for (int i = 0; i < stream.Length; i++)
                {
                    fileBytes[i] = (byte)stream.ReadByte();
                }
            }

            SaveFileName(file.FileName);

            var rootFolder = _hostEnvironment.ContentRootPath;
            System.IO.File.WriteAllBytes(rootFolder + "\\wwwroot\\UploadedFiles\\" + file.FileName, fileBytes);

            ViewBag.Files = GetUploadedFiles();
            ViewBag.Message = "File saved successfully";

            return View();
        }

        [HttpGet]
        public IActionResult Shop()
        {
            var user = _authManager.GetLoggedInUser();
            var order = _dbContext.Orders.Include(o => o.OrderDetails).ThenInclude(d => d.FoodGroup).OrderBy(o => o.DateCreated).FirstOrDefault(o => o.DateCompleted == null && o.UserID == user.UserID);

            if (order == null)
                return View(_dbContext.FoodGroups.OrderBy(g => g.FoodGroupText).Select(g => new ShopViewModel(g)).ToList());
            else
                return View(order.OrderDetails.Select(d => new ShopViewModel(d)).ToList());
        }

        [HttpPost]
        public IActionResult Shop(List<ShopViewModel> orders)
        {
            var user = _authManager.GetLoggedInUser();
            var parentOrder = _dbContext.Orders.Include(o => o.OrderDetails).ThenInclude(d => d.FoodGroup).OrderBy(o => o.DateCreated).FirstOrDefault(o => o.DateCompleted == null && o.UserID == user.UserID);

            if (parentOrder == null)
            {
                parentOrder = new Order();
                parentOrder.UserID = user.UserID;
                parentOrder.DateCreated = DateTime.Now;

                _dbContext.Orders.Add(parentOrder);
            }

            var totalPrice = 0.0;

            foreach (var newOrder in orders)
            {
                var toUpdate = parentOrder.OrderDetails.SingleOrDefault(d => d.FoodGroupID == newOrder.FoodGroupID);
                if (toUpdate == null)
                {
                    toUpdate = new OrderDetail();
                    toUpdate.FoodGroupID = newOrder.FoodGroupID;

                    parentOrder.OrderDetails.Add(toUpdate);
                }

                toUpdate.Quantity = newOrder.Quantity;

                totalPrice += (double)newOrder.Quantity * newOrder.Price;
            }

            parentOrder.TotalPrice = totalPrice;

            _dbContext.SaveChanges();
            return Redirect("/AuthOnly/Pay/" + parentOrder.OrderID.ToString());
        }

        [HttpGet]
        public IActionResult Pay(int id, string message)
        {
            //We should confirm that this order was placed by this user and that it hasn't been submitted before, but we're not
            var order = _dbContext.Orders.Single(o => o.OrderID == id);

            ViewBag.OrderID = order.OrderID;
            ViewBag.TotalPrice = order.TotalPrice;
            ViewBag.Message = message;

            return View();
        }

        [HttpGet]
        public IActionResult Confirm(int OrderID, float TotalPrice, string NameOnCard, string CreditCardNumber, string CreditCardMonth, int CreditCardYear)
        {
            var ccNo = CreditCardNumber.Replace(" ", "");
            if (!Regex.IsMatch(ccNo, "^(?:4[0-9]{12}(?:[0-9]{3})?|[25][1-7][0-9]{14}|6(?:011|5[0-9][0-9])[0-9]{12}|3[47][0-9]{13}|3(?:0[0-5]|[68][0-9])[0-9]{11}|(?:2131|1800|35\\d{3})\\d{11})$"))
            {
                return Redirect($"/AuthOnly/Pay/{OrderID}?message=Invalid Credit Card Number");
            }

            if (CreditCardMonth.NotIn("01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"))
            {
                return Redirect($"/AuthOnly/Pay/{OrderID}?message=Invalid Credit Card Month");
            }

            if (CreditCardYear < DateTime.Now.Year || CreditCardYear > DateTime.Now.Year + 10)
            {
                return Redirect($"/AuthOnly/Pay/{OrderID}?message=Invalid Credit Card Year");
            }

            var model = new ConfirmViewModel();

            model.OrderID = OrderID;
            model.TotalPrice = TotalPrice;
            model.NameOnCard = NameOnCard;
            model.CreditCardNumber = CreditCardNumber;
            model.CreditCardMonth = CreditCardMonth;
            model.CreditCardYear = CreditCardYear;

            return View(model);
        }

        [HttpPost]
        public IActionResult Confirm(ConfirmViewModel model)
        {
            var delay = new Random().Next(500, 1500);

            var order = _dbContext.Orders.SingleOrDefault(o => o.OrderID == model.OrderID);

            if (order != null)
            {
                order.DateCompleted = DateTime.Now;
                order.CreditCardNumber = Encrypt(model.CreditCardNumber);
                order.CreditCardExpirationMonth = Encrypt(model.CreditCardMonth);
                order.CreditCardExpirationYear = model.CreditCardYear;
                _dbContext.SaveChanges();
            }

            //This was put here to fool DAST scanners into thinking that actual credit card processing was happening
            //But it is also a slight DoS risk, so let's see if SAST scanners will find it
            Thread.Sleep(delay);

            return Redirect("Complete");
        }

        [HttpGet]
        public IActionResult Complete()
        {
            return View();
        }

        [HttpGet]
        public IActionResult ViewMyOrders(int id)
        {
            var items = new List<OrderListItemViewModel>();

            var orders = _dbContext.Orders.Include(o => o.OrderDetails).Where(o => o.UserID == id);

            foreach (var order in orders)
            {
                var dateCompleted = order.DateCompleted.HasValue ? order.DateCompleted.Value.ToString() : "N/A";
                var display = $"Order: {order.OrderID}, Completed On: {dateCompleted}, {order.OrderDetails.Count()} items";
                items.Add(new OrderListItemViewModel() { OrderID = order.OrderID, DisplayText = display });
            }

            return View(items);
        }

        [HttpGet]
        public IActionResult OrderDetail(int id)
        {
            var user = _authManager.GetLoggedInUser();
            var order = _dbContext.Orders.Include(o => o.OrderDetails).ThenInclude(d => d.FoodGroup).OrderBy(o => o.DateCreated).FirstOrDefault(o => o.OrderID == id);

            return View(order.OrderDetails.Where(od => od.Quantity > 0).Select(d => new ShopViewModel(d)).ToList());
        }

        public IActionResult FileDownload(int id)
        {
            var user = _authManager.GetLoggedInUser();
            var file = _dbContext.UserFiles.SingleOrDefault(f => f.UserID == user.UserID && f.FileID == id);

            if (file == null)
                return NotFound();

            using (var image = new MemoryStream(file.FileBytes))
            { 
                var extension = file.FileExtension.Replace(".", "");
                return File(image, $"image/{extension}");            
            }
        }

        [HttpGet]
        public IActionResult Overposting()
        {
            var personalInfo = _dbContext.UserPersonalInformations.SingleOrDefault(pi => pi.UserID == _authManager.GetLoggedInUser().UserID);

            if (personalInfo == null)
            {
                personalInfo = new UserPersonalInformation();
                personalInfo.UserID = _authManager.GetLoggedInUser().UserID;
            }

            return View(personalInfo);
        }

        [HttpPost]
        public IActionResult Overposting(UserPersonalInformation info)
        {
            if (_dbContext.UserPersonalInformations.Any(pi => pi.UserID == info.UserID))
                _dbContext.UserPersonalInformations.Update(info);
            else
                _dbContext.UserPersonalInformations.Add(info);

            _dbContext.SaveChanges();

            return View(info);
        }

        private List<string> GetUploadedFiles()
        {
            var list = new List<string>();

            var rootFolder = _hostEnvironment.ContentRootPath;

            var files = Directory.GetFiles(rootFolder + "\\wwwroot\\UploadedFiles\\");

            foreach (var file in files)
            {
                list.Add(Path.GetFileName(file));
            }

            return list;
        }

        private AccountUserViewModel CreateUnsafeGenericModel(string foodName)
        {
            var model = new AccountUserViewModel();
            model.SearchText = foodName;
            var searchText = "SELECT * FROM FoodDisplayView WHERE FoodName LIKE '%" + foodName + "%'";
            model.Foods = _dbContext.ExecSQL<FoodDisplayView>(searchText, null);
            return model;
        }

        private string Encrypt(string toEncrypt)
        {
            byte[] plainTextBytes = UTF8Encoding.UTF8.GetBytes(toEncrypt);

            //RC2 needs a long key to be secure, so let's use a short one here
            var rc2Service = new RC2CryptoServiceProvider();

            rc2Service.Key = new byte[] { 10, 30, 50, 70, 90 };
            rc2Service.IV = new byte[] { 8, 20, 16, 40, 24, 60, 32, 80 };
            rc2Service.Mode = CipherMode.ECB;
            rc2Service.Padding = PaddingMode.PKCS7;

            using (var transform = rc2Service.CreateEncryptor())
            {
                byte[] encryptedBytes = transform.TransformFinalBlock(plainTextBytes, 0, plainTextBytes.Length);
                return Convert.ToBase64String(encryptedBytes, 0, encryptedBytes.Length);
            }
        }

        private void SaveFileName(string fileName)
        {
            _dbContext.Database.ExecuteSqlRaw($"INSERT UnsafeFile (FileName) VALUES (@FileName)", new SqlParameter("@FileName", fileName));
        }
    }

    public static class ExtensionMethods
    {
        public static bool In(this string s, params string[] vals)
        {
            foreach (var val in vals)
            {
                if (s == val)
                    return true;
            }

            return false;
        }

        public static bool NotIn(this string s, params string[] vals)
        {
            var found = false;

            foreach (var val in vals)
            {
                if (s == val)
                    found = true;
            }

            return !found;
        }
    }
}