using System;
using System.Collections.Generic;
using System.Data.SqlClient;
using System.IO;
using System.Linq;
using System.Security.Cryptography;
using System.Threading.Tasks;
using System.Xml;
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.Mvc;
using NCG.SecurityDetection.VulnerabilityBuffet.Data;
using NCG.SecurityDetection.VulnerabilityBuffet.Models;

namespace NCG.SecurityDetection.VulnerabilityBuffet.Controllers
{
    public class MiscellaneousController : Controller
    {
        ApplicationDbContext _context;
        IHostingEnvironment _hostEnv;

        public MiscellaneousController(ApplicationDbContext context, IHostingEnvironment hostingEnvironment)
        {
            _context = context;
            _hostEnv = hostingEnvironment;
        }

        public IActionResult Index()
        {
            return View();
        }

        public IActionResult AngularJS(string id)
        {
            ViewBag.SearchText = id;
            return View();
        }

        [Route("/Miscellaneous/ValueShadowing/{foodName}")]
        public IActionResult ValueShadowing(string foodName)
        {
            if (Request.Cookies["foodName"] != null)
                foodName = Request.Cookies["foodName"];

            if (Request.Query.Keys.Contains("foodName"))
                foodName = Request.Query["foodName"];

            var model = new AccountUserViewModel();

            if (foodName != null && Request.Method != "GET")
            {
                model.SearchText = foodName;
                model.Foods = _context.ExecSQL<FoodDisplayView>("SELECT * FROM FoodDisplayView WHERE FoodName LIKE '%' + @FoodName + '%'", new SqlParameter("@FoodName", foodName));
            }
            else
            {
                model.SearchText = "(None)";
                model.Foods = new List<FoodDisplayView>();
            }

            return View(model);
        }

        [Route("/Miscellaneous/MD5/{foodName}")]
        public IActionResult MD5Hash(string foodName)
        {
            var model = new AccountUserViewModel();

            model.SearchText = foodName;
            model.Foods = _context.ExecSQL<FoodDisplayView>("SELECT * FROM FoodDisplayView WHERE FoodName LIKE '%' + @FoodName + '%'", new SqlParameter("@FoodName", foodName));

            using (var hash = MD5.Create())
            {
                var foodNameAsBytes = System.Text.Encoding.UTF8.GetBytes(foodName);
                var hashedBytes = hash.ComputeHash(foodNameAsBytes);
                var hashedAsString = System.Text.Encoding.UTF8.GetString(hashedBytes);

                Response.Cookies.Append("FoodNameHash", hashedAsString);
            }

            return View(model);
        }

        [HttpGet]
        public IActionResult Xxe()
        {
            ViewBag.SearchText = "";
            return View();
        }

        [HttpPost]
        public IActionResult XxeSearch()
        {
            var xml = "";

            using (var streamReader = new StreamReader(HttpContext.Request.Body))
            {
                xml = streamReader.ReadToEnd();
            }

            ViewBag.SearchText = "";

            var xmlDoc = new XmlDocument();
            xmlDoc.XmlResolver = new XmlUrlResolver();
            xmlDoc.LoadXml(xml);

            var columnName = xmlDoc.SelectSingleNode("/search/for").InnerText;
            var searchType = xmlDoc.SelectSingleNode("/search/type").InnerText;
            var searchText = xmlDoc.SelectSingleNode("/search/text").InnerText;

            var whereClause = "";

            if (searchType == "LIKE")
                whereClause = "LIKE '%' + @FoodName + '%'";
            else //Not a safe assumption, but this is a test/fake site, so let's be sloppy
                whereClause = "= @FoodName";

            var foods = _context.ExecSQL<FoodDisplayView>($"SELECT * FROM FoodDisplayView WHERE {columnName} {whereClause}", new SqlParameter("@FoodName", searchText));

            return Json(new { searchText, foods });
        }

        [HttpGet]
        public IActionResult FileInclusion()
        {
            ViewBag.FileContents = "";
            return View();
        }

        [HttpPost]
        public IActionResult FileInclusion(AccountUserViewModel model)
        {
            SaveFileName(model.SearchText);

            var fullFilePath = _hostEnv.ContentRootPath + "\\wwwroot\\text\\" + model.SearchText;
            var fileContents = System.IO.File.ReadAllText(fullFilePath);
            ViewBag.FileContents = fileContents;

            return View(model);
        }

        [HttpGet]
        public IActionResult JSInjection(string searchText)
        {
            ViewBag.SearchText = searchText;
            return View();
        }

        [HttpPost]
        public IActionResult SearchByName(string id)
        {
            var foods = _context.ExecSQL<FoodDisplayView>($"SELECT * FROM FoodDisplayView WHERE FoodName LIKE '%' + @FoodName + '%'", new SqlParameter("@FoodName", id));

            return Json(new { id, foods });
        }

        [HttpGet]
        public IActionResult CSSInjection()
        {
            ViewBag.Color = "white";
            return View();
        }

        [HttpPost]
        public IActionResult CSSInjection(string color)
        {
            ViewBag.Color = color;

            return View();
        }

        public IActionResult ConnectionString()
        {
            return View();
        }

        private void SaveFileName(string fileName)
        {
            var foods = _context.ExecSQL<FoodDisplayView>($"INSERT UnsafeFile (FileName) VALUES (@FileName)", new SqlParameter("@FileName", fileName));
        }
    }
}